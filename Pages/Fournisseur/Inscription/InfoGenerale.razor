@page "/infoGenerale"
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@using System.Text.Json.Serialization
@using System.Text.RegularExpressions
@inject HttpClient Http

<PageTitle>Informations générales</PageTitle>
<EditForm Model="@identificationModel" OnValidSubmit="HandleValidSubmit">
    <div class="form-group container-fluid h-100 w-100 d-flex align-items-center justify-content-center">
        <div class="row h-100 w-100 d-flex align-items-center justify-content-center">
            <div class="card w-80 h-80 d-flex justify-content-center p-0 m-0">

                @* Coordonnées *@
                <div class="card-header py-2 bg-bleuFonce">
                    <h3 class="py-2 p-0 my-0 text-white titre-bold">Coordonnées de l'entreprise</h3>
                </div>

                <div class="card-body border-bleuFonce bg-blanc py-1">
                    <div class="py-2 d-flex justify-content-between">
                        <div class="col-xl-3 col-lg-3 col-3 col-sm-3">
                            <label class="bleuFonce texte-bold" for="No">No <i class="bi bi-braces-asterisk text-danger"></i></label>
                            <InputText @oninput="ValidateInputs" @bind-Value="identificationModel.noEntreprise" class="form-control input-bleu texte-light" id="No" />
                            @if (isSubmitted && !isNoEntrValid)
                            {
                                if (string.IsNullOrEmpty(identificationModel.noEntreprise))
                                {
                                    <span class="input-group-text text-danger">
                                        <i class="bi bi-x-circle me-2"></i>
                                        <span class="texte-medium">Numéro requis</span>
                                    </span>
                                }
                                else
                                {
                                    <span class="input-group-text text-danger">

                                        <i class="bi bi-x-circle me-2"></i>

                                        <span class="texte-medium">Numéro non conforme</span>
                                    </span>
                                }
                            }
                            else if (isSubmitted && isNoEntrValid)
                            {
                                if (identificationModel.noEntreprise?.ToString().Length > 10)
                                {
                                    <span class="input-group-text text-danger">
                                        <i class="bi bi-x-circle me-2"></i>
                                        <span class="texte-medium">Maximum 8 caractères</span>
                                    </span>
                                }
                                else
                                {
                                    <span class="input-group-text text-success">
                                        <i class="bi bi-check-circle me-2"></i>
                                        <span class="texte-medium">Valide</span>
                                    </span>
                                }
                            }

                        </div>

                        <div class="col-xl-6 col-lg-6 col-6 col-sm-6 ms-1 me-1">
                            <label class="bleuFonce texte-bold" for="Rue">Rue <i class="bi bi-braces-asterisk text-danger"></i></label>
                            <InputText @oninput="ValidateInputs" @bind-Value="identificationModel.rueEntreprise" class="form-control input-bleu texte-light" id="Rue" />
                            @if (isSubmitted && !isRueEntrValid)
                            {
                                <span class="input-group-text text-danger">
                                    <i class="bi bi-x-circle me-2"></i>
                                    <span class="texte-medium">Rue requise</span>
                                </span>
                            }
                            else if (isSubmitted && isRueEntrValid)
                            {
                                <span class="input-group-text text-success">
                                    <i class="bi bi-check-circle me-2"></i>
                                    <span class="texte-medium">Valide</span>
                                </span>
                            }
                        </div>
                        <div class="col-xl-3 col-lg-3 col-3 col-sm-3">
                            <label class="bleuFonce texte-bold" for="Bureau">Bureau <i class="bi bi-braces text-success"></i></label>
                            <InputText @oninput="ValidateInputs" @bind-Value="identificationModel.bureauEntreprise" class="form-control input-bleu texte-light" id="Bureau" />
                            @if (isSubmitted && !isBureauEntrValid && identificationModel.bureauEntreprise != null)
                            {
                                <span class="input-group-text text-danger">
                                    <i class="bi bi-x-circle me-2"></i>
                                    <span class="texte-medium">Maximum 8 caractères</span>
                                </span>
                            }
                            else if (isSubmitted && isBureauEntrValid && identificationModel.bureauEntreprise != null)
                            {
                                <span class="input-group-text text-success">
                                    <i class="bi bi-check-circle me-2"></i>
                                    <span class="texte-medium">Valide</span>
                                </span>
                            }
                        </div>
                    </div>

                    <div class="col-xl-12 col-lg-12 col-12 col-sm-12 py-2">
                        <label class="bleuFonce texte-bold" for="Ville">Ville <i class="bi bi-braces-asterisk text-danger"></i></label>
                        <InputText @oninput="ValidateInputs" @bind-Value="identificationModel.villeEntreprise" class="form-control input-bleu texte-light" id="Ville" />
                        @if (isSubmitted && !isVilleEntrValid)
                        {
                            <span class="input-group-text text-danger">
                                <i class="bi bi-x-circle me-2"></i>
                                @if (string.IsNullOrEmpty(identificationModel.villeEntreprise))
                                {
                                    <span class="texte-medium">Ville requise</span>
                                }
                                else if (identificationModel.villeEntreprise.Length > 64)
                                {
                                    <span class="texte-medium">Maximum 64 caractères</span>
                                }
                            </span>
                        }
                        else if (isSubmitted && isVilleEntrValid)
                        {
                            <span class="input-group-text text-success">
                                <i class="bi bi-check-circle me-2"></i>
                                <span class="texte-medium">Valide</span>
                            </span>
                        }
                    </div>

                    
                    <div class="col-xl-12 col-lg-12 col-12 col-sm-12 py-2">
                        <label class="bleuFonce texte-bold" for="Province">Province <i class="bi bi-braces-asterisk text-danger"></i></label>
                        <InputSelect class="form-control form-select input-bleu texte-light" id="Province" @oninput="ValidateInputs" @bind-Value="identificationModel.provinceEntreprise">
                            <option value="" disabled selected>Veuillez choisir une province</option>
                            @foreach (string province in listeProvinces)
                            {
                                <option value="@province">@province</option>
                            }
                        </InputSelect>
                            @if (isSubmitted && !isProvinceEntrValid)
                            {
                                <span class="input-group-text text-danger">
                                    <i class="bi bi-x-circle me-2"></i>
                                    <span class="texte-medium">Province requise</span>
                                </span>
                            }
                            else if (isSubmitted && isProvinceEntrValid)
                            {
                                <span class="input-group-text text-success">
                                    <i class="bi bi-check-circle me-2"></i>
                                    <span class="texte-medium">Valide</span>
                                </span>
                            }
                    </div>

                    <div class="col-xl-12 col-lg-12 col-12 col-sm-12 py-2">
                        <label class="bleuFonce texte-bold" for="CodePostal">Code Postal <i class="bi bi-braces-asterisk text-danger"></i></label>
                        <InputText @oninput="ValidateInputs" @bind-Value="identificationModel.codePostalEntreprise" class="form-control input-bleu texte-light" id="CodePostal" />
                        @if (isSubmitted && !isCPEntrValid)
                        {
                            <span class="input-group-text text-danger">
                                <i class="bi bi-x-circle me-2"></i>
                                @if (string.IsNullOrEmpty(identificationModel.codePostalEntreprise))
                                {
                                    <span class="texte-medium">Code postal requis</span>
                                }
                                else if (identificationModel.codePostalEntreprise.Length != 6)
                                {
                                    <span class="texte-medium">Doit contenir 6 caractères</span>
                                }
                                else
                                {
                                    <span class="texte-medium">Code postal invalide</span>
                                }
                            </span>
                        }
                        else if (isSubmitted && isCPEntrValid)
                        {
                            <span class="input-group-text text-success">
                                <i class="bi bi-check-circle me-2"></i>
                                <span class="texte-medium">Valide</span>
                            </span>
                        }
                    </div>                    

                    <div class="col-lg-12 col-xl-12 col-12 col-sm-12 py-2">
                        <label class="bleuFonce texte-bold" for="RegionAdm">Région Admnistrative <i class="bi bi-braces-asterisk text-danger"></i></label>
                        <InputSelect id="RegionAdm" @oninput="ValidateInputs" @bind-Value="identificationModel.regionAdmEntreprise" class="form-control form-select input-bleu texte-light">
                            <!--Il faut créer un option qui n'a aucune valeur en selected et en disabled pour éviter que lorsqu'on soumet que la valeur soit nulle-->
                            <option value="" disabled selected>Veuillez choisir une région administrative</option>
                            @foreach (string region in listeRegionADM)
                            {
                                <option value="@region">@region</option>
                            }
                        </InputSelect>
                        @if (isSubmitted && !isRegionEntrValid)
                        {
                            <span class="input-group-text text-danger">
                                <i class="bi bi-x-circle me-2"></i>
                                <span class="texte-medium">Région requise</span>
                            </span>
                        }
                        else if (isSubmitted && isRegionEntrValid)
                        {
                            <span class="input-group-text text-success">
                                <i class="bi bi-check-circle me-2"></i>
                                <span class="texte-medium">Valide</span>
                            </span>
                        }
                    </div>

                    <div class="col-lg-12 col-xl-12 col-12 col-sm-12 py-2">
                        <label class="bleuFonce texte-bold" for="SiteWeb">Site Internet <i class="bi bi-braces text-success"></i></label>
                        <InputText type="" @oninput="ValidateInputs" @bind-Value="identificationModel.siteWebEntreprise" class="form-control input-bleu texte-light" id="SiteWeb" />
                        @if (isSubmitted && !isSiteEntrValid && !string.IsNullOrEmpty(identificationModel.siteWebEntreprise))
                        {
                            <span class="input-group-text text-danger">
                                <i class="bi bi-x-circle me-2"></i>
                                <span class="texte-medium">Maximum 64 caractères</span>
                            </span>
                        }
                        else if (isSubmitted && isSiteEntrValid && !string.IsNullOrEmpty(identificationModel.siteWebEntreprise))
                        {
                            <span class="input-group-text text-success">
                                <i class="bi bi-check-circle me-2"></i>
                                <span class="texte-medium">Valide</span>
                            </span>
                        }
                    </div>

                    <Telephone TelephoneNumber="1" />
                        @foreach (var telephoneNumber in telephoneList)
                        {
                            <Telephone TelephoneNumber="@telephoneNumber" />
                        }

                    <div class="d-flex justify-content-center py-2">
                        <button type="button" class="btn bg-success text-white texte-bold me-2" @onclick="AddTelephone" style="width: 200px;"><i class="bi bi-plus-circle"></i> Ajout téléphone</button>
                        <button type="button" class="btn bg-danger text-white texte-bold" @onclick="RemoveTelephone" style="width: 200px;" disabled="@(!telephoneList.Any())"><i class="bi bi-trash"></i> Retirer téléphone</button>
                    </div>

                </div>
                
                @* Contacts *@
                <div class="card-header py-2 bg-bleuFonce">
                    <h3 class="py-2 p-0 my-0 text-white titre-bold">Contacts</h3>
                </div>

                <div class="card-body border-bleuFonce">
                    <!--
                    <Contact ContactNumber="1" />
                    @foreach (var contactNumber in contactList)
                    {
                        <Contact ContactNumber="@contactNumber" />
                    }
                    -->
                        <div class="d-flex justify-content-center py-2 pb-0">
                            <button type="button" class="btn bg-success text-white texte-bold me-2" @onclick="AddContact" style="width: 200px;"><i class="bi bi-plus-circle"></i> Ajout contact</button>
                            <button type="button" class="btn bg-danger text-white texte-bold" @onclick="RemoveContact" style="width: 200px;" disabled="@(!contactList.Any())"><i class="bi bi-trash"></i> Retirer contact</button>
                        </div>
                </div>

                <div class="card-footer bg-bleuFonce">
                    <div class="d-flex justify-content-center">
                        <button type="submit" class="btn bg-bleu text-white texte-bold" @onclick="SubmitForm" style="width: 200px;">Suivant <i class="bi bi-arrow-right-circle"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <DataAnnotationsValidator />
</EditForm>

@code {
    // Modèle pour les informations générales
    private IdentificationModel identificationModel = new IdentificationModel();
    private List<int> contactList = new List<int>();
    private List<int> telephoneList = new List<int>();
    private int contactCounter = 1;
    private int telephoneCounter = 1;

    #region Listes
    private List<string> listeProvinces = new List<string>{"Québec", "Ontario", "Manitoba", "Saskatchewan", "Alberta", "Colombie-Britanique",
        "Île-du-Prince-Édouard", "Nouveau-Brunswick", "Nouvelle-Écosse", "Terre-Neuve-et-Labrador", "Nunavut", "Territoires du Nord-Ouest",
        "Yukon"};
    private List<string> listeRegionADM = new List<string>{"(01) Bas-Saint-Laurent", "(02) Saguenay-Lac-Saint-Jean", "(03) Capitale-Nationale",
        "(04) Mauricie", "(05) Estrie", "(06) Montréal", "(07) Outaouais", "(08) Abitibi-Témiscamingue", "(09) Côte-Nord", "(10) Nord-du-Québec",
        "(11) Gaspésie-Îles-de-la-Madeleine", "(12) Chaudière-Appalaches", "(13) Laval", "(14) Lanaudière", "(15) Laurentides", "(16) Montérégie",
        "(17) Centre-du-Québec"};
    private List<string> listeTypeContact = new List<string> { "Bureau", "Télécopieur", "Cellulaire" };
    #endregion

    #region Validations
    private bool isSubmitted = false;
    private bool isValid = true;
    private bool isNoEntrValid = true;
    private bool isRueEntrValid = true;
    private bool isBureauEntrValid = true;
    private bool isVilleEntrValid = true;
    private bool isProvinceEntrValid = true;
    private bool isCPEntrValid = true;
    private bool isRegionEntrValid = true;
    private bool isSiteEntrValid = true;
    #endregion

    private void AddContact()
    {
        contactCounter++;
        if (contactCounter <= 5) {
            contactList.Add(contactCounter);
        }
    }

    private void RemoveContact()
    {
        if (contactList.Any())
        {
            contactList.RemoveAt(contactList.Count - 1);
            contactCounter--;
        }
    }

    private void AddTelephone()
    {
        telephoneCounter++;
        if (telephoneCounter <= 5) {
            telephoneList.Add(telephoneCounter);
        }
    }

    private void RemoveTelephone()
    {
        if (telephoneList.Any())
        {
            telephoneList.RemoveAt(telephoneList.Count - 1);
            telephoneCounter--;
        }
    }

    #region Validation des champs
    // Validation de chaque champ
    private void ValidateInputs()
    {
        // Numéro adresse
        if (!string.IsNullOrEmpty(identificationModel.noEntreprise) && identificationModel.noEntreprise.Length <= 8 && Regex.IsMatch(identificationModel.noEntreprise, @"^(\d{1,5}[A-Z]?)\s*(½?)$"))
        {
            isNoEntrValid = true;
        }
        else
        {
            isNoEntrValid = false;
        }

        // Rue adresse
        if (!string.IsNullOrEmpty(identificationModel.rueEntreprise) && identificationModel.rueEntreprise.Length <= 64)
        {
            isRueEntrValid = true;
        }
        else
        {
            isRueEntrValid = false;
        }

        // Bureau adresse
        if (!string.IsNullOrEmpty(identificationModel.bureauEntreprise) && identificationModel.bureauEntreprise.Length <= 8)
        {
            isBureauEntrValid = true;
        }
        else
        {
            isBureauEntrValid = false;
        }

        // Ville adresse
        if (!string.IsNullOrEmpty(identificationModel.villeEntreprise) && identificationModel.villeEntreprise.Length <= 64)
        {
            isVilleEntrValid = true;
        }
        else
        {
            isVilleEntrValid = false;
        }

        // Province adresse
        if (!string.IsNullOrEmpty(identificationModel.provinceEntreprise))
        {
            isProvinceEntrValid = true;
        }
        else
        {
            isProvinceEntrValid = false;
        }

        // Code postal adresse
        // Code postal vide
        if (string.IsNullOrEmpty(identificationModel.codePostalEntreprise))
        {
            isCPEntrValid = false;
        }
        // Longueur invalide
        else if (identificationModel.codePostalEntreprise.Length != 6)
        {
            isCPEntrValid = false;
        }
        // Code postal ne respecte pas les exigences
        else if (Regex.IsMatch(identificationModel.codePostalEntreprise, @"^[A-z]{1}[\d]{1}[A-z]{1}[\d]{1}[A-z]{1}[\d]{1}$"))
        {
            isCPEntrValid = true;
        }
        else
        {
            isCPEntrValid = true;
        }

        // Région adresse
        if (!string.IsNullOrEmpty(identificationModel.regionAdmEntreprise))
        {
            isRegionEntrValid = true;
        }
        else
        {
            isRegionEntrValid = false;
        }

        // Site internet
        // Si une valeur a été saisie
        if (!string.IsNullOrEmpty(identificationModel.siteWebEntreprise))
        {
            // longueur
            if (identificationModel.siteWebEntreprise.Length > 64)
            {
                isSiteEntrValid = false;
            }
            else
            {
                isSiteEntrValid = true;
            }
        }
        // Si pas de valeur saisie, considérée comme valide
        else
        {
            isSiteEntrValid = true;
        }

        // Forcer la mise à jour de l'interface utilisateur
        StateHasChanged();
    }
    #endregion

    // Sert à gérer le scénario où le formulaire est valide.
    public void HandleValidSubmit()
    {
        Console.WriteLine("OnValidSubmit");
    }

    private bool EmailValidator(string email)
    {
        return Regex.IsMatch(email, @"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$") && email.Length <= 64 && !string.IsNullOrEmpty(email);
    }

    private void SubmitForm()
    {
        isSubmitted = true;
        ValidateInputs();
    }

    public class IdentificationModel
    {
        #region coordonnees
        [Required]
        [RegularExpression(@"^(\d{1,5}[A-Z]?)\s*(½?)$")]
        public string? noEntreprise { get; set; }

        [Required]
        public string? rueEntreprise { get; set; }

        [RegularExpression(@"^\d$")]
        public string? bureauEntreprise { get; set; }

        [Required]
        public string? villeEntreprise { get; set; }

        [Required]
        public string? provinceEntreprise { get; set; }

        [Required]
        [RegularExpression(@"^[A-z]{1}[\d]{1}[A-z]{1}[\d]{1}[A-z]{1}[\d]{1}$")]
        public string? codePostalEntreprise { get; set; }

        [Required]
        public int? codeAdmEntreprise { get; set; }

        [Required]
        public string? regionAdmEntreprise { get; set; }

        public string? siteWebEntreprise { get; set; }

        [Required]
        public string? typeTelEntreprise { get; set; }

        [Required]
        [RegularExpression(@"^\d{10}$")]
        public long? noTelEntreprise { get; set; }

        [RegularExpression(@"^\d{6}$")]
        public long? posteTelEntreprise { get; set; }
        #endregion


    }

}