@using Portail_OptiVille.Data.FormModels
@using System.Linq.Expressions
@inject IJSRuntime JSRuntime

<PageTitle>Étape 3 Contacts</PageTitle>
<div class="card-header py-2 bg-bleuFonce">
    <h3 class="py-2 p-0 my-0 text-white titre-bold">Contacts</h3>
</div>
<div class="card-body border-bleuFonce bg-blanc py-1">
    @{
        var contactNo = 1;
        foreach (var contactModel in ContactHosterFormModel.ContactList)
        {
            <Contact ContactNumber="@contactNo" contactFormModel="contactModel" @ref="contactComponents[contactModel]" />
        if (!(ContactHosterFormModel.ContactList.Count == contactNo)) {
                <div class="">
                    <hr class="m-0 mb-2">  
                </div> 
            }    
            contactNo++;        
        }
    }
    <div class="d-flex justify-content-center pb-2">
        <button type="button" class="btn bg-success text-white texte-bold me-2" @onclick="AddContact" style="width: 200px;"><i class="bi bi-plus-circle"></i> Ajout</button>
        <div class="modal fade" id="ModalConfirmation" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header border-0 text-center w-100">
                        <h1 class="modal-title fs-5 mx-auto" id="exampleModalLabel">Êtes-vous sûr de vouloir retirer ce contact</h1>
                    </div>
                    <div class="modal-footer border-0 d-flex justify-content-center">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" @onclick="RemoveContact">Confirmer</button>
                    </div>
                </div>
            </div>
        </div>
        <button type="button" class="btn bg-danger text-white texte-bold" data-bs-target="# ModalConfirmation" data-bs-toggle="modal" style="width: 200px;" disabled="@(!(ContactHosterFormModel.ContactList.Count > 1))"><i class="bi bi-trash"></i> Retirer</button>
    </div>
</div>

<style>
    .valid {
        outline: 1px solid #26b050;
    }
</style>

@code {
    [Parameter]
    public Action<ContactFormHoster>? AssignReference { get; set; }
    [Parameter]
    public ContactHosterFormModel ContactHosterFormModel { get; set; }
    private Dictionary<ContactFormModel, Contact> contactComponents = new Dictionary<ContactFormModel, Contact>();
    private EditContext editContext { get; set; }
    private bool isSubmit = false;

    protected override void OnInitialized()
    {
        editContext = new EditContext(ContactHosterFormModel);
        editContext.OnValidationStateChanged += (sender, args) => StateHasChanged();
        AssignReference?.Invoke(this);
        if (!ContactHosterFormModel.ContactList.Any()) {
            ContactHosterFormModel.ContactList.Add(new ContactFormModel());
        }
    }

    private string GetInputClass<TField> (Expression<Func<TField>> fieldExpression)
    {
        if (!isSubmit) {
           return "";
        }
        var fieldIdentifier = FieldIdentifier.Create(fieldExpression);
        var isValid = !editContext.GetValidationMessages(fieldIdentifier).Any();
        return isValid ? "valid" : "invalid";
    }

    private string GetValidationHTML<TField> (Expression<Func<TField>> fieldExpression) 
    {
        if (!isSubmit) {
           return "";
        }
        var fieldIdentifier = FieldIdentifier.Create(fieldExpression);
        var isValid = !editContext.GetValidationMessages(fieldIdentifier).Any();
        return isValid ? "<span class=\"input-group-text text-success\"><i class=\"bi bi-check-circle me-2\"></i><span class=\"texte-medium\">Valide</span></span>" 
                       : "<span class=\"input-group-text text-danger\"><i class=\"bi bi-x-circle me-2\"></i><span class=\"texte-medium\">" + editContext.GetValidationMessages(fieldIdentifier).FirstOrDefault() + "</span></span>";  
    }

    public bool TriggerValidation() 
    {
        isSubmit = true;
        StateHasChanged();
        var isAllContactsValid = ValidateContacts();
        if (editContext.Validate() && isAllContactsValid)
        {
            return true;
        }
        return false;
    }

    private void AddContact()
    {
        ContactHosterFormModel.ContactList.Add(new ContactFormModel());
    }

     private void RemoveContact()
    {
        if (ContactHosterFormModel.ContactList.Count > 1) {
            ContactHosterFormModel.ContactList.RemoveAt(ContactHosterFormModel.ContactList.Count - 1);
        }
    }

    public bool ValidateContacts()
    {
        bool isValid = true;
        foreach (var component in contactComponents.Values) {
            var contactState = component.TriggerValidation();
            if (!contactState) {
                isValid = false;
            }
        }
        return isValid;
    }
}